"""
cvescanner/package.py
    -- scan installed packages
"""

import pip
from pip.util import get_installed_distributions
import datetime
import nvd
import exploitdb

this_year = datetime.datetime.now().year

# WAT Not sure we should be excluding these from checks, but pip.command.freeze does...
excludes = ['setuptools', 'pip', 'distribute']


def freezer(local=False, skip=excludes):
    """
    Return a dict of installed python package versions keyed by name.
    """
    installations = {}
    for dist in get_installed_distributions(local_only=local, skip=skip):
        req = pip.FrozenRequirement.from_dist(dist, [])
        installations[req.name] = dist.version
    return installations


def scan(path=None, year=this_year, local=False, verbose=False):

    (parser, path) = nvd.get(year, path=path, verbose=verbose)
    frozen = freezer(local=local)
    for key in sorted(frozen.iterkeys()):
        cves = nvd.scan(year=year, name=key, version=frozen[key], verbose=verbose)
        if not cves:
            continue
        print "Found %d vulnerabilities for %s %s:" % (len(cves), key, frozen[key]), cves
        for cve in cves:
            exploits = exploitdb.search(cve)
            if exploits:
                print "Found exploits for %s: %s" % (cve, exploits)
